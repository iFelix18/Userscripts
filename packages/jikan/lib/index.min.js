// ==UserScript==
// @author       Davide <iFelix18@protonmail.com>
// @namespace    https://github.com/iFelix18
// @exclude      *
// ==UserLibrary==
// @name         @ifelix18/jikan
// @description  Jikan API for my userscripts
// @copyright    2022, Davide (https://github.com/iFelix18)
// @license      MIT
// @version      2.0.0
// @homepage     https://github.com/iFelix18/Userscripts/tree/master/packages/jikan#readme
// @homepageURL  https://github.com/iFelix18/Userscripts/tree/master/packages/jikan#readme
// @supportURL   https://github.com/iFelix18/Userscripts/issues
// ==/UserLibrary==
// @connect      api.jikan.moe
// @grant        GM.xmlHttpRequest
// ==/UserScript==
this.Jikan=function(){const t={"/anime/search":{method:"GET",url:"/anime?q={query}&type={type}&order_by={order_by}&sfw={sfw}&page={page}"}};return class{constructor(t={}){this._config={api_url:t.api_url||"https://api.jikan.moe/v4",limit:t.limit||25,debug:t.debug||!1},this._headers={"User-Agent":"Mozilla/5.0","Content-Type":"application/json;charset=utf-8"},this._debug=t=>{(this._config.debug||200!==t.status)&&console.log(`${t.status}: ${t.finalUrl}`)},this._this=this,this._methods()}_methods(){for(const e in t){const s=e.split("/"),i=s.pop();s.shift();let o=this._this;for(const t of s)o=o[t]||(o[t]={});o[i]=this._request.bind(this,t[e])}}_request(t,e){return new Promise(((s,i)=>{const o=this._resolve(t,e);GM.xmlHttpRequest({method:t.method,url:o,headers:this._headers,timeout:15e3,onload:t=>{this._debug(t);const e=JSON.parse(t.responseText).data;e.length>0&&4===t.readyState&&200===t.status?s(e):i(new Error("No results"))},onerror:()=>{i(new Error("An error occurs while processing the request"))},ontimeout:()=>{i(new Error("Request times out"))}})}))}_resolve(t,e){const s=this._config.api_url,i=t.url.split("?"),o=[],r=[];if(i[0]&&o.push(i[0]),i[1])for(const t of i[1].split("&")){const s=new RegExp(Object.keys(e).map((t=>`{${t}}`)).join("|"),"gi");s.test(t)&&r.push(t.replace(s,(t=>e[t.replace(/[{}]/g,"")])))}return this._config.limit&&r.push(`limit=${this._config.limit}`),`${s}${o.join("")}?${r.join("&")}`}}}();
