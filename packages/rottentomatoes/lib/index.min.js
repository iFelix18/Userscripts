// ==UserScript==
// @author       Davide <iFelix18@protonmail.com>
// @namespace    https://github.com/iFelix18
// @exclude      *
// ==UserLibrary==
// @name         @ifelix18/rottentomatoes
// @description  Rotten Tomatoes API for my userscripts
// @copyright    2022, Davide (https://github.com/iFelix18)
// @license      MIT
// @version      2.0.0
// @homepage     https://github.com/iFelix18/Userscripts/tree/master/packages/rottentomatoes#readme
// @homepageURL  https://github.com/iFelix18/Userscripts/tree/master/packages/rottentomatoes#readme
// @supportURL   https://github.com/iFelix18/Userscripts/issues
// ==/UserLibrary==
// @connect      rottentomatoes.com
// @grant        GM.xmlHttpRequest
// ==/UserScript==
this.RottenTomatoes=function(){const t={"/movie/search":{method:"GET",url:"/search/?q={query}&t=movie"},"/tv/search":{method:"GET",url:"/search/?q={query}&t=tvseries"}};return class{constructor(t={}){this._config={api_url:t.api_url||"https://www.rottentomatoes.com/api/private/v2.0",limit:t.limit||25,debug:t.debug||!1},this._headers={"User-Agent":"Mozilla/5.0","Content-Type":"application/json;charset=utf-8"},this._debug=t=>{(this._config.debug||200!==t.status)&&console.log(`${t.status}: ${t.finalUrl}`)},this._this=this,this._methods()}_methods(){for(const e in t){const s=e.split("/"),r=s.pop();s.shift();let o=this._this;for(const t of s)o=o[t]||(o[t]={});o[r]=this._request.bind(this,t[e])}}_request(t,e){if(!e.query)throw new Error("A search query is required");return new Promise(((s,r)=>{const o=this._resolve(t,e);GM.xmlHttpRequest({method:t.method,url:o,headers:this._headers,timeout:15e3,onload:t=>{this._debug(t);const e=JSON.parse(t.responseText);4===t.readyState&&200===t.status?s(e):r(new Error("No results"))},onerror:()=>{r(new Error("An error occurs while processing the request"))},ontimeout:()=>{r(new Error("Request times out"))}})}))}_resolve(t,e){const s=this._config.api_url,r=t.url.split("?"),o=[],i=[];if(r[0]&&o.push(r[0]),r[1])for(const t of r[1].split("&"))if(e){const s=new RegExp(Object.keys(e).map((t=>`{${t}}`)).join("|"),"gi");i.push(t.replace(s,(t=>e[t.replace(/[{}]/g,"")])))}else i.push(t);return this._config.limit&&i.push(`limit=${this._config.limit}`),`${s}${o.join("")}?${i.join("&")}`}}}();
